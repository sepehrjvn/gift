<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>قاب عکس WebAR – نمونه اولیه</title>
  <!-- A-Frame و MindAR از CDN -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://unpkg.com/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    body, html { margin: 0; padding: 0; background:#000; height: 100%; }
    #ui { position: fixed; z-index: 10; inset: 0 auto auto 0; padding: 10px; color: #fff; font-family: sans-serif; }
    .hint { position: fixed; inset: auto 0 0 0; color:#fff; text-align:center; padding:10px; background:linear-gradient(transparent, rgba(0,0,0,.6)); font-family: sans-serif; }
    .btn { background:#ffffff22; border:1px solid #ffffff55; color:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; margin-inline-end:6px; }
  </style>
</head>
<body>
  <!-- UI ساده برای کنترل و راهنمای کاربر -->
  <div id="ui">
    <button id="btnStart" class="btn">شروع اسکن</button>
    <button id="btnMute" class="btn">🔇 بی‌صدا</button>
  </div>
  <div class="hint">گوشی را به قاب/تصویر هدف بگیرید تا ویدئو داخل قاب پخش شود.</div>

  <!-- صحنه WebAR: MindAR با A-Frame و ردیابی تصویر -->
  <a-scene
    mindar-image="imageTargetSrc: ./targets/target.mind; filterMinCF:0.001; filterBeta: 0.01; warmupTolerance: 5;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true, physicallyCorrectLights: true"
    embedded>

    <!-- دوربین MindAR -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- ریشه ویژگیِ هدف شماره ۰ -->
    <a-entity mindar-image-target="targetIndex: 0">
      <!-- سطح پخش ویدئو: ابعاد این صفحه باید با نسبت تصویر هدف هماهنگ باشد -->
      <a-video
        id="videoPlane"
        src="#videoEl"
        position="0 0 0"
        rotation="0 0 0"
        width="1"
        height="0.5625"  
        material="shader: flat; transparent: true;"
        loop="true"
      ></a-video>

      <!-- یک حاشیه‌ی نازک برای القای حس «داخل قاب بودن» -->
      <a-plane position="0 0 -0.002" width="1.05" height="0.59" color="#111" material="opacity:0.6"></a-plane>
    </a-entity>
  </a-scene>

  <!-- المان ویدئو واقعی HTML5 که روی صفحه سه‌بعدی نگاشت می‌شود -->
  <video id="videoEl" playsinline webkit-playsinline preload="auto" muted loop style="display:none">
    <!-- ویدئوی خود را جایگزین کنید -->
    <source src="./targets/video.mp4" type="video/mp4" />
  </video>

  <script>
    // کنترل‌های ساده برای شروع/توقف اسکن و بی‌صدا/با صدا
    const btnStart = document.getElementById('btnStart');
    const btnMute = document.getElementById('btnMute');
    const videoEl = document.getElementById('videoEl');

    // iOS و بسیاری از مرورگرها فقط ویدئوی «muted» را خودکار پخش می‌کنند
    videoEl.muted = true;

    // وقتی هدف پیدا شد، ویدئو را پخش کن
    const sceneEl = document.querySelector('a-scene');
    sceneEl.addEventListener('targetFound', () => {
      videoEl.play().catch(()=>{});
    });
    sceneEl.addEventListener('targetLost', () => {
      videoEl.pause();
    });

    btnStart.addEventListener('click', async () => {
      try {
        // درخواست دسترسی به دوربین
        await navigator.mediaDevices.getUserMedia({ video: true });
        // شروع MindAR (وقتی کاربر با UI تعامل کند، محدودیت‌های autoplay رفع می‌شود)
        sceneEl.systems['mindar-image-system'].start();
        // شروع پخش بی‌صدا (برای iOS)
        await videoEl.play().catch(()=>{});
        btnStart.textContent = 'اسکن فعال است';
        btnStart.disabled = true;
      } catch (e) {
        alert('عدم دسترسی به دوربین. لطفاً اجازه‌ی دسترسی بدهید.');
      }
    });

    btnMute.addEventListener('click', () => {
      videoEl.muted = !videoEl.muted;
      btnMute.textContent = videoEl.muted ? '🔇 بی‌صدا' : '🔊 با صدا';
      if (!videoEl.paused) videoEl.play().catch(()=>{});
    });
  </script>
</body>
</html>
