<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Ù‚Ø§Ø¨ Ø¹Ú©Ø³ WebAR â€“ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡Ù” Ø¯ÙˆØ±Ø¨ÛŒÙ†</title>
  <meta name="color-scheme" content="dark" />

  <style>
    html, body { height:100%; margin:0; background:#000; color:#eee; font-family:system-ui,Segoe UI,Roboto,Arial; }
    /* ÙˆÛŒØ¯Ø¦Ùˆ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡Ù” Ø¯ÙˆØ±Ø¨ÛŒÙ†: Ù¾Ø´Øª Ù‡Ù…Ù‡â€ŒÚ†ÛŒØ²ØŒ ÙÙˆÙ„â€ŒØ§Ø³Ú©Ø±ÛŒÙ† */
    #bgcam {
      position: fixed; inset: 0; width: 100%; height: 100%;
      object-fit: cover; z-index: 0; background: #000;
      transform: scaleX(1); /* Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´ØªÛŒØ› Ø§Ú¯Ø± Ø³Ù„ÙÛŒ Ø´Ø¯ØŒ scaleX(-1) */
    }
    /* Ø¨ÙˆÙ… A-Frame Ø´ÙØ§Ù Ùˆ Ø±ÙˆÛŒ ÙˆÛŒØ¯Ø¦Ùˆ */
    .a-canvas {
      position: fixed !important; inset: 0 !important;
      z-index: 1 !important; background: transparent !important;
    }
    /* UI Ø¨Ø§Ù„Ø§ Ø¯Ø³Øª Ù‡Ù…Ù‡ */
    #ui {
      position: fixed; left:0; top:0; z-index: 10;
      display:flex; gap:8px; align-items:center; padding:10px 12px;
      background:linear-gradient(90deg, rgba(0,0,0,.6), rgba(0,0,0,0));
      backdrop-filter:saturate(120%) blur(4px);
    }
    .btn { background:#ffffff22; border:1px solid #ffffff55; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn[disabled]{ opacity:.5; cursor:default; }
    .hint{ position:fixed; left:0; right:0; bottom:0; z-index:10; text-align:center; padding:10px 12px;
           background:linear-gradient(transparent, rgba(0,0,0,.65)); }
    #status{ position:fixed; top:50px; left:10px; z-index:10; background:#0008; color:#0f0; padding:6px 10px; border-radius:8px; font:12px/1.6 monospace; }

    /* Ù¾Ù†Ù„ Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ† */
    #calib{
      position:fixed; right:10px; top:10px; z-index:11;
      background:#000a; color:#fff; padding:10px; border-radius:12px;
      font:12px system-ui; width:220px
    }
    #calib label{ display:block; margin:4px 0 }
    #calib input[type="range"]{ width:100% }
    #calib .row{ display:flex; gap:6px; margin-top:6px }
    #calib button{ flex:1; padding:6px 8px; border-radius:8px; border:1px solid #555; background:#111; color:#fff; cursor:pointer }
  </style>

  <!-- Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ (ØªÙˆØµÛŒÙ‡ Ø´Ø¯Ù‡ Ø¯Ø± Ø§ÛŒØ±Ø§Ù†): Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ú©Ù„ dist Ø§Ø² mind-ar@1.2.5 Ø¯Ø± lib/ Ù‡Ø³Øª -->
  <script src="./lib/aframe.min.js"></script>
  <script src="./lib/mindar-image-aframe.prod.js"></script>
</head>
<body>
  <!-- ÙˆÛŒØ¯Ø¦ÙˆÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ú©Ù‡ Ø§Ø³ØªØ±ÛŒÙ… Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±ÙˆÛŒ Ø¢Ù† Ù…ÛŒâ€ŒÙ†Ø´ÛŒÙ†Ø¯ -->
  <video id="bgcam" autoplay playsinline muted></video>

  <!-- UI -->
  <div id="ui">
    <button id="btnStart" class="btn">Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†</button>
    <button id="btnMute" class="btn">ğŸ”‡ Ø¨ÛŒâ€ŒØµØ¯Ø§</button>
    <span id="status">status: boot</span>
  </div>

  <!-- Ù¾Ù†Ù„ Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ† Ø²Ù†Ø¯Ù‡ -->
  <div id="calib">
    <div style="margin-bottom:6px;font-weight:600">Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ†</div>
    <label>Scale W <input id="sw" type="range" min="0.80" max="1.20" step="0.001" value="1.000"></label>
    <label>Scale H <input id="sh" type="range" min="0.80" max="1.20" step="0.001" value="1.000"></label>
    <label>Offset X <input id="ox" type="range" min="-0.10" max="0.10" step="0.001" value="0.000"></label>
    <label>Offset Y <input id="oy" type="range" min="-0.10" max="0.10" step="0.001" value="0.000"></label>
    <label>RotateÂ° <input id="rt" type="range" min="-5" max="5" step="0.1" value="0.0"></label>
    <div class="row">
      <button id="saveCal">Ø°Ø®ÛŒØ±Ù‡</button>
      <button id="resetCal">Ø±ÛŒØ³Øª</button>
    </div>
  </div>

  <div class="hint">Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ù‡ ØªØµÙˆÛŒØ± Ù‡Ø¯Ù Ø¨Ú¯ÛŒØ±Ø› ÙˆÙ‚ØªÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯ØŒ ÙˆÛŒØ¯ÛŒÙˆ Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¨ Ù¾Ø®Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>

  <!-- ÙˆÛŒØ¯Ø¦ÙˆÛŒ Ù…Ø­ØªÙˆØ§ÛŒ Ù‡Ø¯ÛŒÙ‡ Ú©Ù‡ Ø±ÙˆÛŒ Ù‚Ø§Ø¨ Ù…ÛŒâ€ŒØ§ÙØªØ¯ -->
  <video id="videoEl" playsinline webkit-playsinline preload="auto" loop muted crossorigin="anonymous" style="display:none">
    <source src="./targets/video.mp4" type="video/mp4" />
  </video>

  <!-- ØµØ­Ù†Ù‡Ù” A-Frame Ø¨Ø§ Ø´ÙØ§ÙÛŒØª ØªØ§ bgcam Ø¯ÛŒØ¯Ù‡ Ø´ÙˆØ¯ -->
  <a-scene
    mindar-image="imageTargetSrc: ./targets/target.mind; autoStart: true; filterMinCF:0.001; filterBeta:0.01;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true">

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Ú¯Ø±Ù‡ Ù‡Ø¯Ù -->
    <a-entity mindar-image-target="targetIndex: 0">
      <!-- (Ù¾Ø§ÛŒØ¯Ø§Ø±ØªØ± Ø§Ø² <a-video>): plane Ø¨Ø§ Ù…ØªØ±ÛŒØ§Ù„ ÙˆÛŒØ¯Ø¦Ùˆ -->
      <a-plane id="videoPlane"
               position="0 0 0.0001"
               rotation="0 0 0"
               width="1"
               height="0.5625"
               material="shader: flat; src: #videoEl; transparent: true;">
      </a-plane>

      <!-- Ø­Ø§Ø´ÛŒÙ‡Ù” ØªÛŒØ±Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ø³ Ù‚Ø§Ø¨ -->
      <a-plane position="0 0 -0.002" width="1.05" height="0.59" color="#111" material="opacity:0.6"></a-plane>
    </a-entity>
  </a-scene>

  <script>
    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const btnStart = $('#btnStart');
    const btnMute  = $('#btnMute');
    const sceneEl  = document.querySelector('a-scene');
    const videoEl  = $('#videoEl');
    const bgcam    = $('#bgcam');
    const videoPlane = document.getElementById('videoPlane');

    // Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ†
    const sw = document.getElementById('sw');
    const sh = document.getElementById('sh');
    const ox = document.getElementById('ox');
    const oy = document.getElementById('oy');
    const rt = document.getElementById('rt');
    const saveCal = document.getElementById('saveCal');
    const resetCal = document.getElementById('resetCal');

    const setStatus = s => { statusEl.textContent = 'status: ' + s; console.log('[status]', s); };

    // Ø¨Ø±Ø§ÛŒ autoplay Ù…ÙˆØ¨Ø§ÛŒÙ„ØŒ Ù…Ø­ØªÙˆØ§ÛŒ Ù‡Ø¯ÛŒÙ‡ Ø±Ø§ Ø¨ÛŒâ€ŒØµØ¯Ø§ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    videoEl.muted = true;

    // ÙÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± Ù†Ø³Ø¨Øª ÙˆÛŒØ¯ÛŒÙˆ Ø±ÙˆÛŒ Ù‚Ø§Ø¨ (Ø¹Ø±Ø¶ Ù¾Ø§ÛŒÙ‡ = 1)
    let baseH = 0.5625; // Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØªØ§ Ù‚Ø¨Ù„ Ø§Ø² Ù„ÙˆØ¯ Ù…ØªØ§Ø¯ÛŒØªØ§
    function fitPlaneToVideo(){
      const vw = videoEl.videoWidth || 0, vh = videoEl.videoHeight || 0;
      if (!vw || !vh) return;
      const ar = vw / vh;
      baseH = 1 / ar; // Ú†ÙˆÙ† width=1
      videoPlane.setAttribute('width', 1);
      videoPlane.setAttribute('height', baseH);
      // Ú©Ù…ÛŒ Ø¬Ù„Ùˆ Ø¢ÙˆØ±Ø¯Ù† ØªØ§ Ø²ÙØ¯-ÙØ§ÛŒØªÛŒÙ†Ú¯ Ú©Ù… Ø´ÙˆØ¯
      videoPlane.setAttribute('position', `${ox.value} ${oy.value} 0.0001`);
      applyCal(); // Ø¨Ø¹Ø¯ Ø§Ø² ÙÛŒØªØŒ Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ† Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯
      console.log('fitPlaneToVideo:', {vw, vh, ar, width:1, height:baseH});
    }

    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ MindAR Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
    sceneEl.addEventListener('loaded',   () => setStatus('scene loaded'));
    sceneEl.addEventListener('arReady',  () => {
      setStatus('ar ready (waiting for target)');
      // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø³ØªØ±ÛŒÙ… Ø¯Ø§Ø®Ù„ÛŒ MindAR Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª)
      const candidates = Array.from(document.querySelectorAll('video')).filter(v => v !== videoEl && v !== bgcam && v.srcObject);
      if (candidates[0]) {
        try {
          bgcam.srcObject = candidates[0].srcObject;
          bgcam.play().catch(()=>{});
          setStatus('bg from MindAR stream');
        } catch(e) { console.warn('bgcam attach from MindAR failed', e); }
      }
    });
    sceneEl.addEventListener('arError',  (e) => { setStatus('ar error'); console.error(e); });
    sceneEl.addEventListener('targetFound', () => { setStatus('target found â†’ playing'); videoEl.play().catch(()=>{}); });
    sceneEl.addEventListener('targetLost',  () => { setStatus('lost â†’ paused'); videoEl.pause(); });

    // Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹: Ù…Ø¬ÙˆØ² Ø¯ÙˆØ±Ø¨ÛŒÙ† + Ù†Ù…Ø§ÛŒØ´ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
    btnStart.addEventListener('click', async () => {
      try {
        if (!isSecureContext) { alert('Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ HTTPS Ø¨Ø§Ø² Ø´ÙˆØ¯ (GitHub Pages Ø§ÙˆÚ©ÛŒ Ø§Ø³Øª).'); return; }
        if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
          throw new TypeError('getUserMedia Ø¯Ø± Ø§ÛŒÙ† Ù…Ø­ÛŒØ· Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.');
        }
        setStatus('requesting camera permission');
        // Ø§Ø³ØªØ±ÛŒÙ… Ø¨Ø±Ø§ÛŒ bg Ùˆ Ú˜Ø³Øª Ú©Ø§Ø±Ø¨Ø± (MindAR Ù‡Ù… Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø³Ú©Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
        bgcam.srcObject = stream;
        await bgcam.play().catch(()=>{});
        // kick autoplay Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ¯Ø¦ÙˆÛŒ Ù…Ø­ØªÙˆØ§ÛŒ Ù‡Ø¯ÛŒÙ‡
        await videoEl.play().catch(()=>{});
        btnStart.textContent = 'Ø§Ø³Ú©Ù† ÙØ¹Ø§Ù„ Ø´Ø¯';
        btnStart.disabled = true;
        setStatus('ready (point camera to target)');
      } catch (err) {
        console.error(err);
        setStatus('error');
        alert('Camera error: ' + (err.name || err.message || err));
      }
    });

    // Ø¯Ú©Ù…Ù‡ Ø¨ÛŒâ€ŒØµØ¯Ø§/Ø¨Ø§ ØµØ¯Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø­ØªÙˆØ§ÛŒ Ù‡Ø¯ÛŒÙ‡
    btnMute.addEventListener('click', () => {
      videoEl.muted = !videoEl.muted;
      btnMute.textContent = videoEl.muted ? 'ğŸ”‡ Ø¨ÛŒâ€ŒØµØ¯Ø§' : 'ğŸ”Š ØµØ¯Ø§ Ø±ÙˆØ´Ù†';
      if (!videoEl.paused) videoEl.play().catch(()=>{});
    });

    // Ù„Ø§Ú¯ ÙˆÛŒØ¯Ø¦Ùˆ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¯Ø±ÛŒØ§ÙØª ÙØ±ÛŒÙ…
    videoEl.addEventListener('loadedmetadata', () => {
      console.log('video meta:', videoEl.videoWidth, 'x', videoEl.videoHeight, 'dur=', videoEl.duration);
      fitPlaneToVideo();
    });
    videoEl.addEventListener('loadeddata', () => {
      console.log('video first frame ready');
      fitPlaneToVideo();
      // Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ±ØŒ Ø³Ù¾Ø³ Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ† Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒÙ…
      setTimeout(loadCal, 50);
    });

    // ---- Calibration logic ----
    function applyCal(){
      const W = 1 * parseFloat(sw.value);
      const H = baseH * parseFloat(sh.value);
      videoPlane.setAttribute('width',  W);
      videoPlane.setAttribute('height', H);

      const x = parseFloat(ox.value);
      const y = parseFloat(oy.value);
      const r = parseFloat(rt.value);
      videoPlane.setAttribute('position', `${x} ${y} 0.0001`);
      videoPlane.setAttribute('rotation', `0 0 ${r}`);
    }
    function loadCal(){
      const s = localStorage.getItem('calib') || '{}';
      try{
        const c = JSON.parse(s);
        if (c.sw) sw.value = c.sw;
        if (c.sh) sh.value = c.sh;
        if (c.ox) ox.value = c.ox;
        if (c.oy) oy.value = c.oy;
        if (c.rt) rt.value = c.rt;
      }catch{}
      applyCal();
    }
    function saveCalib(){
      const c = { sw:sw.value, sh:sh.value, ox:ox.value, oy:oy.value, rt:rt.value };
      localStorage.setItem('calib', JSON.stringify(c));
    }
    function resetCalib(){
      sw.value = sh.value = '1.000';
      ox.value = oy.value = '0.000';
      rt.value = '0.0';
      saveCalib();
      applyCal();
    }
    [sw,sh,ox,oy,rt].forEach(el=>el.addEventListener('input', applyCal));
    saveCal.addEventListener('click', saveCalib);
    resetCal.addEventListener('click', resetCalib);
  </script>
</body>
</html>
