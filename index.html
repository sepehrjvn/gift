<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Ù‚Ø§Ø¨ Ø¹Ú©Ø³ WebAR â€“ Ù†Ø³Ø®Ù‡Ù” Ù†Ù‡Ø§ÛŒÛŒ</title>

  <!-- A-Frame Ùˆ MindAR Ø§Ø² CDN (jsDelivr Ù¾Ø§ÛŒØ¯Ø§Ø±) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; background:#000; }
    body { font-family: system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; color:#eee; }

    #ui {
      position: fixed; inset: 0 auto auto 0; z-index: 10;
      display: flex; gap: 8px; align-items: center; padding: 10px 12px;
      background: linear-gradient(90deg, rgba(0,0,0,.6), rgba(0,0,0,0));
      backdrop-filter: saturate(120%) blur(4px);
    }
    .btn {
      background:#ffffff22; border:1px solid #ffffff55; color:#fff;
      padding:6px 10px; border-radius:10px; cursor:pointer; font-size:14px;
    }
    .btn[disabled] { opacity:.6; cursor:default; }

    .hint {
      position: fixed; inset: auto 0 0 0; z-index: 9; text-align:center;
      padding:10px 12px; font-size: 13px;
      background: linear-gradient(transparent, rgba(0,0,0,.6));
    }

    #status {
      position:fixed; top:50px; left:10px; z-index:10;
      background:#0008; color:#0f0; padding:6px 10px; border-radius:8px;
      font:12px/1.6 monospace;
    }
  </style>
</head>
<body>
  <!-- UI -->
  <div id="ui">
    <button id="btnStart" class="btn">Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†</button>
    <button id="btnMute"  class="btn">ğŸ”‡ Ø¨ÛŒâ€ŒØµØ¯Ø§</button>
    <span style="margin-inline-start:auto;font-size:12px;opacity:.8">HTTPS Ùˆ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§ØµÙ„ÛŒ (Chrome/Safari)</span>
  </div>
  <div id="status">status: boot</div>
  <div class="hint">Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ù‡ Ù‚Ø§Ø¨/ØªØµÙˆÛŒØ± Ù‡Ø¯Ù Ø¨Ú¯ÛŒØ±ÛŒØ¯ ØªØ§ ÙˆÛŒØ¯Ø¦Ùˆ Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¨ Ù¾Ø®Ø´ Ø´ÙˆØ¯.</div>

  <!-- ØµØ­Ù†Ù‡ WebAR Ø¨Ø§ autoStart -->
  <a-scene
    mindar-image="imageTargetSrc: ./targets/target.mind; autoStart: true; filterMinCF: 0.001; filterBeta: 0.01;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    renderer="colorManagement: true; physicallyCorrectLights: true"
    embedded>

    <!-- Ø¯ÙˆØ±Ø¨ÛŒÙ† MindAR -->
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Ø±ÛŒØ´Ù‡Ù” Ù‡Ø¯Ù Ø´Ù…Ø§Ø±Ù‡ Û° -->
    <a-entity mindar-image-target="targetIndex: 0">
      <!-- Ø³Ø·Ø­ Ù¾Ø®Ø´ ÙˆÛŒØ¯ÛŒÙˆ (Ø§ÛŒÙ†Ø¬Ø§ 16:9Ø› Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² height Ø±Ø§ Ø¹ÙˆØ¶ Ú©Ù†) -->
      <a-video
        id="videoPlane"
        src="#videoEl"
        position="0 0 0"
        rotation="0 0 0"
        width="1"
        height="0.5625"
        material="shader: flat; transparent: true;">
      </a-video>

      <!-- Ø­Ø§Ø´ÛŒÙ‡Ù” ØªÛŒØ±Ù‡ Ù¾Ø´Øª ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ø­Ø³ Ù‚Ø§Ø¨ -->
      <a-plane position="0 0 -0.002" width="1.05" height="0.59" color="#111" material="opacity:0.6"></a-plane>
    </a-entity>
  </a-scene>

  <!-- ÙˆÛŒØ¯ÛŒÙˆÛŒ HTML5 Ú©Ù‡ Ø±ÙˆÛŒ ØµÙØ­Ù‡Ù” Ø³Ù‡â€ŒØ¨Ø¹Ø¯ÛŒ Ù†Ú¯Ø§Ø´Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
  <video id="videoEl" playsinline webkit-playsinline preload="auto" muted loop style="display:none">
    <!-- ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø®ÙˆØ¯ØªØ§Ù† Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ -->
    <source src="./targets/video.mp4" type="video/mp4" />
  </video>

  <script>
  (function(){
    const btnStart = document.getElementById('btnStart');
    const btnMute  = document.getElementById('btnMute');
    const videoEl  = document.getElementById('videoEl');
    const sceneEl  = document.querySelector('a-scene');
    const statusEl = document.getElementById('status');

    const setStatus = (s)=>{ statusEl.textContent = 'status: ' + s; console.log('[status]', s); };

    // Ø¨Ø±Ø§ÛŒ autoplay Ù…ÙˆØ¨Ø§ÛŒÙ„ØŒ Ø¨ÛŒâ€ŒØµØ¯Ø§ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    videoEl.muted = true;

    // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ Ø¨Ø§ Ù†Ú©Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ
    function showCameraError(err){
      console.error('Camera error:', err);
      alert(
        'Ù…Ø´Ú©Ù„ Ø¯ÙˆØ±Ø¨ÛŒÙ†: ' + (err && (err.name || err.message || err)) + '\n\n' +
        (location.protocol==='https:' ? '' : 'âš ï¸ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±ÙˆÛŒ HTTPS Ù†ÛŒØ³Øª.\n') +
        (navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? '' : 'âš ï¸ Ù…Ø±ÙˆØ±Ú¯Ø± getUserMedia Ù†Ø¯Ø§Ø±Ø¯.\n') +
        'Ù†Ú©Ø§Øª:\n- ØµÙØ­Ù‡ Ø±Ø§ Ø¯Ø± Safari ÛŒØ§ Chrome Ø§ØµÙ„ÛŒ Ø¨Ø§Ø² Ú©Ù† (Ù†Ù‡ Ø¯Ø§Ø®Ù„ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…/ØªÙ„Ú¯Ø±Ø§Ù…).\n' +
        '- Ø¨Ù‡ Ø³Ø§ÛŒØª Ø§Ø¬Ø§Ø²Ù‡ Camera Ø¨Ø¯Ù‡.\n' +
        '- Ø§Ú¯Ø± VPN/Recorder Ø¯ÙˆØ±Ø¨ÛŒÙ† ÙØ¹Ø§Ù„Ù‡ØŒ Ø¨Ø¨Ù†Ø¯.\n' +
        '- Ù‡Ù…Ù‡Ù” ØªØ¨â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø§ Ø¨Ø¨Ù†Ø¯ Ùˆ Ø±ÛŒÙØ±Ø´ Ú©Ù†.'
      );
    }

    // Ø¨Ø¹Ø¯ Ø§Ø² Ù„ÙˆØ¯ ØµØ­Ù†Ù‡ØŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù†Ø¯
    sceneEl.addEventListener('loaded', () => {
      setStatus('scene loaded');

      // Ø§ÛŒÙˆÙ†Øªâ€ŒÙ‡Ø§ÛŒ MindAR
      sceneEl.addEventListener('arReady', () => setStatus('ar ready (waiting for target)'));
      sceneEl.addEventListener('arError', (e) => { setStatus('ar error'); console.error(e); });
      sceneEl.addEventListener('targetFound', () => { setStatus('target found â†’ playing'); videoEl.play().catch(()=>{}); });
      sceneEl.addEventListener('targetLost',  () => { setStatus('target lost â†’ paused'); videoEl.pause(); });

      // Ø¯Ú©Ù…Ù‡Ù” ØµØ¯Ø§
      btnMute.addEventListener('click', () => {
        videoEl.muted = !videoEl.muted;
        btnMute.textContent = videoEl.muted ? 'ğŸ”‡ Ø¨ÛŒâ€ŒØµØ¯Ø§' : 'ğŸ”Š ØµØ¯Ø§ Ø±ÙˆØ´Ù†';
        if (!videoEl.paused) videoEl.play().catch(()=>{});
      });

      // Ø¯Ú©Ù…Ù‡Ù” Ø´Ø±ÙˆØ¹: Ú¯Ø±ÙØªÙ† Ø§Ø¬Ø§Ø²Ù‡Ù” Ú©Ø§Ø±Ø¨Ø± Ùˆ kick Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ autoplay
      btnStart.addEventListener('click', async () => {
        try {
          if (!isSecureContext) { alert('Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ HTTPS Ø¨Ø§Ø² Ø´ÙˆØ¯.'); return; }
          if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
            throw new TypeError('getUserMedia Ø¯Ø± Ø§ÛŒÙ† Ù…Ø­ÛŒØ· Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.');
          }
          setStatus('requesting camera permission');
          // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø¬ÙˆØ² Ø¯ÙˆØ±Ø¨ÛŒÙ† (Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ø¢Ø²Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          stream.getTracks().forEach(t => t.stop());
          // kick Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø®ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§
          await videoEl.play().catch(()=>{});
          btnStart.textContent = 'Ø§Ø³Ú©Ù† ÙØ¹Ø§Ù„ Ø§Ø³Øª';
          btnStart.disabled = true;
          setStatus('ready (point camera to target)');
        } catch (err) {
          showCameraError(err);
          setStatus('error');
        }
      });

      // ØªØ¹Ø§Ù…Ù„ Ù„Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù…Ú© Ø¨Ù‡ autoplay Ø¯Ø± iOS
      document.addEventListener('touchend', function once(){
        videoEl.play().catch(()=>{});
        document.removeEventListener('touchend', once, false);
      }, false);
    });
  })();
  </script>
</body>
</html>
