<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Ù‚Ø§Ø¨ Ø¹Ú©Ø³ WebAR â€“ Ù†Ø³Ø®Ù‡Ù” Ù†Ù‡Ø§ÛŒÛŒ</title>
  <meta name="color-scheme" content="dark">

  <style>
    html, body { height: 100%; margin: 0; background:#000; color:#eee; }
    body { font-family: system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; }
    #ui {
      position: fixed; inset: 0 auto auto 0; z-index: 10;
      display: flex; gap: 8px; align-items: center; padding: 10px 12px;
      background: linear-gradient(90deg, rgba(0,0,0,.6), rgba(0,0,0,0));
      backdrop-filter: saturate(120%) blur(4px);
    }
    .btn {
      background:#ffffff22; border:1px solid #ffffff55; color:#fff;
      padding:6px 10px; border-radius:10px; cursor:pointer; font-size:14px;
    }
    .btn[disabled] { opacity:.6; cursor:default; }
    .hint {
      position: fixed; inset: auto 0 0 0; z-index: 9; text-align:center;
      padding:10px 12px; font-size: 13px;
      background: linear-gradient(transparent, rgba(0,0,0,.6));
    }
    #status {
      position:fixed; top:50px; left:10px; z-index:10;
      background:#0008; color:#0f0; padding:6px 10px; border-radius:8px;
      font:12px/1.6 monospace;
    }
    noscript {
      position: fixed; inset: 0; display:flex; align-items:center; justify-content:center;
      background:#000; color:#fff; z-index: 9999; padding:20px; text-align:center;
    }
  </style>

  <!-- Ù„ÙˆØ¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯: Ø§ÙˆÙ„ Ù…Ø­Ù„ÛŒØŒ Ø¨Ø¹Ø¯ jsDelivrØŒ Ø¨Ø¹Ø¯ unpkg -->
  <script>
  (function(){
    function loadScriptSequential(urls){
      return new Promise((resolve, reject)=>{
        let i = 0;
        function next(){
          if(i >= urls.length) return reject(new Error('Failed to load: ' + urls.join(' | ')));
          const s = document.createElement('script');
          s.src = urls[i++];
          s.onload = () => resolve();
          s.onerror = () => next();
          document.head.appendChild(s);
        }
        next();
      });
    }

    // Ø§ÙˆÙ„ A-FrameØŒ Ø¨Ø¹Ø¯ MindAR
    window.libsReady = (async () => {
      // A-Frame
      await loadScriptSequential([
        './lib/aframe.min.js',
        'https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js',
        'https://unpkg.com/aframe@1.5.0/dist/aframe.min.js'
      ]);
      // MindAR Image (A-Frame)
      await loadScriptSequential([
        './lib/mindar-image-aframe.prod.js',
        'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js',
        'https://unpkg.com/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js'
      ]);
    })();
  })();
  </script>
</head>
<body>
  <noscript>Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ AR Ø¨Ø§ÛŒØ¯ JavaScript ÙØ¹Ø§Ù„ Ø¨Ø§Ø´Ø¯.</noscript>

  <!-- UI -->
  <div id="ui">
    <button id="btnStart" class="btn">Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†</button>
    <button id="btnMute"  class="btn">ğŸ”‡ Ø¨ÛŒâ€ŒØµØ¯Ø§</button>
    <span style="margin-inline-start:auto;font-size:12px;opacity:.8">HTTPS Ùˆ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§ØµÙ„ÛŒ (Chrome/Safari)</span>
  </div>
  <div id="status">status: boot</div>
  <div class="hint">Ú¯ÙˆØ´ÛŒ Ø±Ø§ Ø¨Ù‡ Ù‚Ø§Ø¨/ØªØµÙˆÛŒØ± Ù‡Ø¯Ù Ø¨Ú¯ÛŒØ±ÛŒØ¯ ØªØ§ ÙˆÛŒØ¯Ø¦Ùˆ Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¨ Ù¾Ø®Ø´ Ø´ÙˆØ¯.</div>

  <!-- ÙˆÛŒØ¯ÛŒÙˆ HTML5 Ú©Ù‡ Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ø³Ù‡â€ŒØ¨Ø¹Ø¯ÛŒ Ù†Ú¯Ø§Ø´Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
  <video id="videoEl" playsinline webkit-playsinline preload="auto" muted loop style="display:none">
    <!-- ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø®ÙˆØ¯ØªØ§Ù† Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ -->
    <source src="./targets/video.mp4" type="video/mp4" />
  </video>

  <!-- ØµØ­Ù†Ù‡ Ø±Ø§ Ø¨Ø¹Ø¯ Ø§Ø² Ù„ÙˆØ¯ Ù„Ø§ÛŒØ¨Ø±Ø±ÛŒâ€ŒÙ‡Ø§ ØªØ²Ø±ÛŒÙ‚ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø§Ú¯Ø± Ù„Ø§ÛŒØ¨Ø±Ø±ÛŒ Ù†ÛŒØ§Ù…Ø¯ØŒ Ø®Ø·Ø§ Ù†Ø¯Ù‡Ø¯ -->
  <div id="sceneHost"></div>

  <script>
  (async function(){
    const statusEl = document.getElementById('status');
    const setStatus = (s)=>{ statusEl.textContent = 'status: ' + s; console.log('[status]', s); };

    try {
      setStatus('loading libs');
      await window.libsReady;
      if (!window.AFRAME) throw new Error('A-Frame NOT loaded');
      setStatus('libs loaded');
    } catch (e) {
      setStatus('libs failed to load');
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„Ø§ÛŒØ¨Ø±Ø±ÛŒâ€ŒÙ‡Ø§. Ø§Ú¯Ø± Ø§ÛŒØ±Ø§Ù† Ù‡Ø³ØªÛŒØŒ CDNÙ‡Ø§ Ù…Ù…Ú©Ù†Ù‡ Ú©Ù†Ø¯/Ø¨Ù„Ø§Ú© Ø¨Ø§Ø´Ù†Ø¯. Ø¨Ù‡ØªØ±Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± Ù¾ÙˆØ´Ù‡ lib/ Ù…Ø­Ù„ÛŒ Ú©Ù¾ÛŒ Ú©Ù†ÛŒ.');
      console.error(e);
      return;
    }

    // ØµØ­Ù†Ù‡ A-Frame + MindAR Ø±Ø§ ØªØ²Ø±ÛŒÙ‚ Ú©Ù†
    const host = document.getElementById('sceneHost');
    host.innerHTML = `
      <a-scene
        mindar-image="imageTargetSrc: ./targets/target.mind; autoStart: true; filterMinCF: 0.001; filterBeta: 0.01;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        renderer="colorManagement: true; physicallyCorrectLights: true"
        embedded>
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity mindar-image-target="targetIndex: 0">
          <a-video id="videoPlane" src="#videoEl" position="0 0 0" rotation="0 0 0"
                   width="1" height="0.5625" material="shader: flat; transparent: true;"></a-video>
          <a-plane position="0 0 -0.002" width="1.05" height="0.59" color="#111" material="opacity:0.6"></a-plane>
        </a-entity>
      </a-scene>
    `;

    const btnStart = document.getElementById('btnStart');
    const btnMute  = document.getElementById('btnMute');
    const videoEl  = document.getElementById('videoEl');
    const sceneEl  = document.querySelector('a-scene');

    // autoplay-safe
    videoEl.muted = true;

    // Ù¾Ø±ÛŒÙÙÙ„Ø§ÛŒØª: ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±Ú¯Øª Ø±Ø§ Ú†Ú© Ú©Ù† ØªØ§ Ø§Ú¯Ø± 404 Ø¨ÙˆØ¯ØŒ Ø²ÙˆØ¯ Ø¨ÙÙ‡Ù…ÛŒÙ…
    async function head(url){
      try {
        const r = await fetch(url + '?nocache=' + Date.now(), { method: 'HEAD' });
        return r.ok ? null : (r.status + ' ' + r.statusText);
      } catch(e){ return e.message || String(e); }
    }
    setStatus('preflight');
    const errMind = await head('./targets/target.mind');
    const errVid  = await head('./targets/video.mp4');
    if (errMind) { setStatus('missing ./targets/target.mind â†’ ' + errMind); return; }
    if (errVid)  { setStatus('missing ./targets/video.mp4 â†’ ' + errVid); return; }

    // Ø§ÛŒÙˆÙ†Øªâ€ŒÙ‡Ø§
    sceneEl.addEventListener('loaded', () => setStatus('scene loaded'));
    sceneEl.addEventListener('arReady', () => setStatus('ar ready (waiting for target)'));
    sceneEl.addEventListener('arError', (e) => { setStatus('ar error'); console.error(e); });
    sceneEl.addEventListener('targetFound', () => { setStatus('target found â†’ playing'); videoEl.play().catch(()=>{}); });
    sceneEl.addEventListener('targetLost',  () => { setStatus('target lost â†’ paused');  videoEl.pause(); });

    // Ø¯Ú©Ù…Ù‡ ØµØ¯Ø§
    btnMute.addEventListener('click', () => {
      videoEl.muted = !videoEl.muted;
      btnMute.textContent = videoEl.muted ? 'ğŸ”‡ Ø¨ÛŒâ€ŒØµØ¯Ø§' : 'ğŸ”Š ØµØ¯Ø§ Ø±ÙˆØ´Ù†';
      if (!videoEl.paused) videoEl.play().catch(()=>{});
    });

    // Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹: Ù…Ø¬ÙˆØ² Ø¯ÙˆØ±Ø¨ÛŒÙ† + kick autoplay
    btnStart.addEventListener('click', async () => {
      try {
        if (!isSecureContext) { alert('Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ HTTPS Ø¨Ø§Ø² Ø´ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ GitHub Pages).'); return; }
        if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
          throw new TypeError('getUserMedia Ø¯Ø± Ø§ÛŒÙ† Ù…Ø­ÛŒØ· Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª.');
        }
        setStatus('requesting camera permission');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        stream.getTracks().forEach(t => t.stop());
        await videoEl.play().catch(()=>{});
        btnStart.textContent = 'Ø§Ø³Ú©Ù† ÙØ¹Ø§Ù„ Ø§Ø³Øª';
        btnStart.disabled = true;
        setStatus('ready (point camera to target)');
      } catch (err) {
        console.error('Camera error:', err);
        alert('Ù…Ø´Ú©Ù„ Ø¯ÙˆØ±Ø¨ÛŒÙ†: ' + (err.name || err.message || err));
        setStatus('error');
      }
    });

    // Ú©Ù…Ú© Ø¨Ù‡ autoplay Ø¯Ø± iOS
    document.addEventListener('touchend', function once(){
      videoEl.play().catch(()=>{});
      document.removeEventListener('touchend', once, false);
    }, false);

  })();
  </script>
</body>
</html>
